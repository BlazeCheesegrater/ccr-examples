Bootstrap: docker
From: nvcr.io/nvidia/pytorch:24.10-py3

%labels
  org.opencontainers.image.authors OpenFold Team
  org.opencontainers.image.source https://github.com/aqlaboratory/openfold
  org.opencontainers.image.licenses Apache License 2.0
  org.opencontainers.image.base.name docker.io/nvidia/cuda:12.6.3-base-ubuntu24.04

%setup
  # create mountpoint for /scratch during the build (for ${SLURMTMPDIR})
  mkdir "${APPTAINER_ROOTFS}/scratch"

%files
  environment.yml /opt/openfold/environment.yml

%arguments
    SLURMTMPDIR=""
    SLURM_NPROCS=""

%post -c /bin/bash
  export SLURMTMPDIR="{{ SLURMTMPDIR }}"
  export SLURM_NPROCS="{{ SLURM_NPROCS }}"

  # Set the timezone, if unset
  test -h /etc/localtime || ln -fs /usr/share/zoneinfo/America/New_York /etc/localtime

  cp /etc/apt/sources.list /etc/apt/sources.list~
  sed -E -i 's/^# deb-src /deb-src /' /etc/apt/sources.list
  apt-get -y update

  # Install man & man pages - this section can be removed if not needed
  # NOTE: Do this before installing anything else so their man pages are installed
  sed -e '\|/usr/share/man|s|^#*|#|g' -i /etc/dpkg/dpkg.cfg.d/excludes
  DEBIAN_FRONTEND=noninteractive apt-get -y install apt-utils groff dialog man-db manpages manpages-posix manpages-dev
  rm -f /usr/bin/man
  dpkg-divert --quiet --remove --rename /usr/bin/man

  # O/S package updates:
  DEBIAN_FRONTEND=noninteractive apt-get -y upgrade

  DEBIAN_FRONTEND=noninteractive apt-get -y install \
   tzdata \
   locales \
   unzip \
   wget \
   git \
   curl \
   jq \
   nano \
   vim \
   apt-file

  # NOTE: apt-file is generally not needed to run, but can be useful during development
  apt-file update

  # These steps are necessary to configure Perl and can cause issues with Python if omitted
  sed -i -e 's/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/' /etc/locale.gen
  dpkg-reconfigure --frontend=noninteractive locales
  update-locale LANG=en_US.UTF-8

  # max parallelism for ninja
  export MAX_JOBS="$(expr ${SLURM_NPROCS:-$(nproc)} - 3)"
  if [ ${MAX_JOBS} -lt 1 ]xi
  then
    MAX_JOBS=1
  fi

  # use all the available cores for cmake parallel builds
  export CMAKE_BUILD_PARALLEL_LEVEL="${MAX_JOBS}"

  # Following build based on the Dockerfile

  export CONDA_PREFIX="/opt/conda"
  export CUDA_HOME="${CONDA_PREFIX}"
  export CUDATOOLKIT_HOME="${CUDA_HOME}"
  export CUDNN_HOME="${CUDA_HOME}"
  uid="$(head -1 /proc/self/uid_map | awk '{print $2}')"
  export TMPDIR="${SLURMTMPDIR:-/var/tmp}/tmp_${uid}"
  mkdir -p "${TMPDIR}"
  export CUDA_CACHE_PATH="${TMPDIR}/cache/cuda"
  mkdir -p "${CUDA_CACHE_PATH}"
  export PIP_CACHE_DIR="${TMPDIR}/cache/pip"
  mkdir -p "${PIP_CACHE_DIR}"
  export CONDA_PKGS_DIRS="${TMPDIR}/cache/conda"
  mkdir -p "${CONDA_PKGS_DIRS}"
  export PATH=/opt/conda/bin:$PATH
  export LD_LIBRARY_PATH="${CONDA_PREFIX}/lib:${LD_LIBRARY_PATH}"

  # set up Miniforge
  miniforge_version="23.3.1-1"
  #miniforge_version="25.3.0-3"
  wget -P /tmp \
   "https://github.com/conda-forge/miniforge/releases/download/${miniforge_version}/Miniforge3-$(uname)-$(uname -m).sh"
  bash /tmp/Miniforge3-$(uname)-$(uname -m).sh -b -p /opt/conda
  rm /tmp/Miniforge3-$(uname)-$(uname -m).sh

  cd /opt/conda
  mamba env update -n base --file /opt/openfold/environment.yml
  mamba clean --all -y
  # manually install flash-attn with --no-build-isolation
  pip install flash-attn --no-build-isolation
  # install CUDA TensorFlow
  pip install 'tensorflow[and-cuda]' tensorrt polygraphy
  cd /root
  git clone https://github.com/aqlaboratory/openfold.git
  cd openfold
  cp -r openfold /opt/openfold/openfold
  cp -r scripts /opt/openfold/scripts
  # Note: Copying the "tests" dir is only required to run the test script
  #         bash /opt/openfold/scripts/run_unit_tests.sh -v tests.test_model
  #       This can be omitted if not running this test:
  cp -r tests /opt/openfold/tests
  cp run_pretrained_openfold.py /opt/openfold/run_pretrained_openfold.py
  cp train_openfold.py /opt/openfold/train_openfold.py
  cp setup.py /opt/openfold/setup.py
  cd ..
  rm -rf openfold
  cd /opt/openfold
  # cuda-bindings 13.0.0 introduced a breaking change - cuda.cudart was
  # replaced by cuda.bindings.runtime
  sed -E -i '/^[[:space:]]*import[[:space:]]+cuda\.cudart/s/cuda\.cudart/cuda.bindings.runtime/' ./openfold/utils/tensorrt_lazy_compiler.py
  wget -q -P /opt/openfold/openfold/resources \
    https://git.scicore.unibas.ch/schwede/openstructure/-/raw/7102c63615b64735c4941278d92b554ec94415f8/modules/mol/alg/src/stereo_chemical_props.txt
  python3 setup.py install

%environment
  export LANG=en_US.UTF-8 
  export CONDA_PREFIX="/opt/conda"
  export CUDA_HOME="${CONDA_PREFIX}"
  export OF_DIR="/opt/openfold"
  export LD_LIBRARY_PATH="${CONDA_PREFIX}/lib:/usr/local/lib:${LD_LIBRARY_PATH}"
  export PYTHONPATH="${OF_DIR}:/opt/conda/lib/python3.10/site-packages:${PYTHONPATH}"
  export PATH="${CONDA_PREFIX}/bin:${PATH}"

%runscript
  #!/bin/bash
  uid="$(head -1 /proc/self/uid_map | awk '{print $2}')"
  export TMPDIR="${SLURMTMPDIR:-$(echo ",${APPTAINER_BIND}," | grep -q ",/scratch," && echo "/scratch" || echo "/var/tmp")}/tmp_${uid}"
  mkdir -p "${TMPDIR}"
  export CUDA_CACHE_PATH="${TMPDIR}/cache/cuda"
  mkdir -p "${CUDA_CACHE_PATH}"
  export PIP_CACHE_DIR="${TMPDIR}/cache/pip"
  mkdir -p "${PIP_CACHE_DIR}"
  export CONDA_PKGS_DIRS="${TMPDIR}/cache/conda"
  mkdir -p "${CONDA_PKGS_DIRS}"
  export TRITON_CACHE_DIR="${TMPDIR}/cache/triton"
  mkdir -p "${TRITON_CACHE_DIR}"
  # Exec passed command (required for Modal ENTRYPOINT compatibility)
  exec "$@"

